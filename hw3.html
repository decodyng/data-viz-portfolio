<!DOCTYPE html>
<html lang="en">
<head>
	<title>Time Series Visualizations</title>
	<meta charset="utf-8">
	<meta name="author" content="pixelhint.com">
	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
	<link rel="icon" href="favicon.ico" type="image/x-icon">
	<meta name="description" content="Magnetic is a stunning responsive HTML5/CSS3 photography/portfolio website  template"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />
	<link rel="stylesheet" type="text/css" href="css/reset.css">
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<link rel="stylesheet" type="text/css" href="css/d3.parcoords.css">
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/d3.js"></script>
    <script type="text/javascript" src="js/d3.parcoords.js"></script>
    <script type="text/javascript" src="js/d3-tip.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <style>
    	.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis text{
	color:white;
}
.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke-width: 2px;
}

.petrolline{
	stroke:#bcbddc;
}
.deathline{
	stroke:#fc9272;
}
.background{
	fill:none;
}

.area {
  fill: #bcbddc;
  clip-path: url(#clip);
}

.top {
			background: url('img/highway.jpg') no-repeat;
		}

/*.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
*/
.brush .extent {
  stroke: #fff;
  fill-opacity: .125;
  shape-rendering: crispEdges;
}


    </style>
</head>
<body>

	<header>
		<div class="logo">
			<a href="index.html"><img src="img/logo.png" title="Magnetic" alt="Magnetic"/></a>
		</div><!-- end logo -->

		<!--<div id="menu_icon"></div>
		<nav>
			<ul>
				<li><a href="index.html" class="selected">Home</a></li>
				<li><a href="#">About</a></li>
				<li><a href="#">The Team</a></li>
				<li><a href="#">Journal</a></li>
				<li><a href="contact.html">Contact Us</a></li>
			</ul>
		</nav>end navigation menu -->

		<div> 
			<h5 style="text-align:center; line-height:160%">This site is a repository for projects completed as part of MSAN's Information Visualization course</h5><h6 style="text-align:center">Code available at https://github.com/decodyng/data-viz-portfolio</h6>
		</div>
 
		<div class="footer clearfix">
			<ul class="social clearfix">
				<li><a href="http://decodyng.com/" target="_blank" class="website" data-title="Website"></a></li>
				<li><a href="https://twitter.com/decodyng" target="_blank" class="twitter" data-title="Twitter"></a></li>
				<li><a href="mailto:cody.marie.wild@gmail.com" target="_blank" class="email" data-title="Email"></a></li>
				<li><a href="#" target="_blank" class="mobile" data-title="814.414.7199"></a></li>
				<!--<li><a href="#" class="twitter" data-title="Twitter"></a></li>
				<li><a href="#" class="dribble" data-title="Dribble"></a></li>-->
				<!--<li><a href="#" class="rss" data-title="RSS"></a></li>-->
			</ul><!-- end social -->

			<div class="rights">
				<!--<p>Copyright Â© 2014 magnetic.</p>-->
				<p style="font-size:7px; text-align:center;">Template by <a href="">Pixelhint.com</a></p>
			</div><!-- end rights -->
		</div ><!-- end footer -->
	</header><!-- end header -->

	<section class="main clearfix">

		<section class="top">	
			<div class="wrapper content_header clearfix">
				<div class="work_nav">
							
					<ul class="btn clearfix">
						<li><a href="#" class="previous" data-title="Previous"></a></li>
						<li><a href="index.html" class="grid" data-title="Portfolio"></a></li>
						<li><a href="#" class="next" data-title="Next"></a></li>
					</ul>							
					
				</div><!-- end work_nav -->
				<h1 class="title">Time Series Visualizations</h1>


			</div>		
		</section><!-- end top -->

		<section class="wrapper">
			<div class="content">
			<h1 style="text-align:center">Fuel Prices and Driver Deaths: 1969-1984</h1>
			<h4 style="margin-bottom:20px; text-align:center">Death rates shown with respect to seasonal average values</h4>
			<svg id="petrol"></svg>
			<svg id="drivdeath"></svg>
			<p style="text-align:center">This visualization utilizes linked views with tooltip annotation to trace both UK fuel prices and recorded driver deaths throughout time. Since driver death is clearly a highly seasonal phenomenon, values are present both in their absolute form and relative to the average for a given month across the full time period. </p>
			<br/>
			<hr>
			<hr>
			<br/>
			<h1 style="text-align:center">Driver Casualties Over Time: <span style="color:#fc9272">Deaths</span> vs <span style="color:#bcbddc">Injuries</span></h1>
			<svg id="deathinj"></svg>
			<p style="text-align:center">This visualization explores total UK driver casualties, broken down into deaths vs injuries. I chose to show the smaller values (deaths) on the lower part of the stacked area to avoid visual distortion of the shape of the deaths area due to the huge difference in scale between the two values. This visual further allows viewers to use brushing and panning to zoom in onto smaller areas of the time series.</p>
			<br/>
			<p><b>Functionality List:</b>
			<ul>
				<li>Basic: Line plot(s)</li>
				<li>Basic: Area plot</li>
				<li>Moderate: Details on demand (both local and with respect to seasonal average) on line plots</li>
				<li>Moderate: Panning on area plot</li>
				<li>Advanced: Linked views on line plots</li>
				<li>Advanced: Brushing on area plot</li>

			</ul>
			Code available <a href="https://github.com/decodyng/data-viz-portfolio/blob/gh-pages/hw3.html">here</a> 
			</p>
				
			</div><!-- end content -->
		</section>
	</section><!-- end main -->
	<script>
	
 
	var margin = {top: 20, right: 80, bottom: 30, left: 50};
    var width = 900 - margin.left - margin.right; 
    var height = 200 - margin.top - margin.bottom;

	var parseDate = d3.time.format("%Y-%m-%d").parse;
	var line_x = d3.time.scale().range([0, width]);
	var pet_y = d3.scale.linear().range([height, 0]);
	var death_y = d3.scale.linear().range([height, 0]);
	var line_xAxis = d3.svg.axis()
			    .scale(line_x)
			    .orient("bottom");
	var pet_yAxis = d3.svg.axis()
		    .scale(pet_y)
		    .orient("left")
		    .ticks(4);
	var death_yAxis = d3.svg.axis()
	    .scale(death_y)
	    .orient("left")
	    .ticks(5);

	 var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "June",
  "July", "Aug", "Sep", "Oct", "Nov", "Dec"
		];

	var monthFullNames = ["January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"
		];
	 var monthAvgs = [120.81, 107.31, 107, 105.6, 111.44, 115.88, 116.31, 115.25, 116.31, 115.25, 124.125, 141.06, 150.625, 158.25];

	// 
	var area_padding = {left:25, right:25, bottom:20}
	var area_margin = {top: 10, right: 10, bottom: 100, left: 40};
    var area_margin2 = {top: 430, right: 10, bottom: 20, left: 40};
    var area_width = 960 - area_margin.left - area_margin.right - area_padding.left - area_padding.right; 
    var area_height = 500 - area_margin.top - area_margin.bottom;
    var area_height2 = 500 - area_margin2.top - area_margin2.bottom - area_padding.bottom;


    var area_x = d3.time.scale().range([0, area_width]);
    var area_x2 = d3.time.scale().range([0, area_width]);
    var area_y = d3.scale.linear().range([area_height, 0]);
    var area_y2 = d3.scale.linear().range([area_height2, 0]);

    var area_xAxis = d3.svg.axis().scale(area_x).orient("bottom");
    var area_xAxis2 = d3.svg.axis().scale(area_x2).orient("bottom");
    var area_yAxis = d3.svg.axis().scale(area_y).orient("left");

    

	var area = d3.svg.area()
	    .interpolate("monotone")
	    .x(function(d) { return area_x(d.month); })
	    .y0(area_height)
	    .y1(function(d) { return area_y(d.driversInjured); });

	var area2 = d3.svg.area()
	    .interpolate("monotone")
	    .x(function(d) { return area_x2(d.month); })
	    .y0(area_height2)
	    .y1(function(d) { return area_y2(d.driversInjured)});

	var area_svg = d3.select("#deathinj")
	    .attr("width", area_width + area_margin.left + area_margin.right)
	    .attr("height", area_height + area_margin.top + area_margin.bottom)
	    .style("padding-left", area_padding.left)
	    .style("padding-right", area_padding.right);

	area_svg.append("defs").append("clipPath")
	    .attr("id", "clip")
	  .append("rect")
	    .attr("width", area_width)
	    .attr("height", area_height);

	var focus = area_svg.append("g")
	    .attr("class", "focus")
	    .attr("transform", "translate(" + area_margin.left + "," + area_margin.top + ")");

	var context = area_svg.append("g")
	    .attr("class", "context")
	    .attr("transform", "translate(" + area_margin2.left + "," + area_margin2.top + ")");

	d3.csv("seatbelts2.csv", function(error, data){
		data.forEach(function(d){
			d.month = parseDate(d.month);
			d.DriversKilled = +d.DriversKilled;
			d.driversInjured= +d.driversInjured;
			d.kms = +d.kms;
		});

		// line plot 
		var timedomain = d3.extent(data, function(d) { return d.month; });
		var timearray = data.map(function(d){
	    	return d.month.getMonth() + " " + d.month.getFullYear(); 
	    });

	    var fullDatesArray = data.map(function(d){
	    	return d.month;
	    })

		line_x.domain(timedomain);
		var petExtent = d3.extent(data, function(d){return d.PetrolPrice}); 
		pet_y.domain(petExtent);
		var deathExtent = d3.extent(data, function(d){return d.DriversKilled});
		death_y.domain(deathExtent);

		var pet_line = d3.svg.line()
	    .interpolate("basis")
	    .x(function(d) { return line_x(d.month); })
	    .y(function(d) { return pet_y(d.PetrolPrice); });

		var death_line = d3.svg.line()
		    .interpolate("basis")
		    .x(function(d) { return line_x(d.month); })
		    .y(function(d) { return death_y(d.DriversKilled); });

 		petrol_svg = d3.select("#petrol")
 		.attr("width", width + margin.right + margin.left)
	    .attr("height", height + margin.top + margin.bottom)
	  	.append("g")
	    	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");


	    death_svg = d3.select("#drivdeath")
 		.attr("width", width + margin.right + margin.left)
	    .attr("height", height + margin.top + margin.bottom)
	  	.append("g")
	    	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	    var death_values = data.map(function(d){
	    	return d.DriversKilled; 
	    })

	    var petrol_values = data.map(function(d){
	    	return d.PetrolPrice; 
	    });

	    mouseover = function(){
	    	death_circle.transition().duration(300).attr("opacity", 1.0);
	    	petrol_circle.transition().duration(300).attr("opacity", 1.0);
	    	syear1.transition().duration(300).attr("opacity", 0);
	    	syear2.transition().duration(300).attr("opacity", 0);
	    	petrolLabel.transition().duration(300).attr("opacity", 0);
		  	deathLabel.transition().duration(300).attr("opacity", 0);
		  	d3.selectAll(".static_year").classed("hidden", true);
		  	// petrol_axistext.transition().duration(350).attr("opacity", 0);
		  	// death_axistext.transition().duration(350).attr("opacity", 0);
		 	mousemove.call(this);
	    	};

	   	mouseout = function(){
	   		d3.selectAll(".static_year").classed("hidden", false);
	   	// 	petrol_axistext.transition().duration(350).attr("opacity", 1);
		  	// death_axistext.transition().duration(350).attr("opacity", 1);
		  	petrolLabel.transition().duration(300).attr("opacity", 1.0);
		  	deathLabel.transition().duration(300).attr("opacity", 1.0);
		  	syear1.transition().duration(300).attr("opacity", 1.0);
	    	syear2.transition().duration(300).attr("opacity", 1.0);
		  death_circle.transition().duration(300).attr("opacity", 0);
		  petrol_circle.transition().duration(300).attr("opacity", 0);
		  death_caption.transition().duration(300).text("");
		  death_caption2.transition().duration(300).text("");
		  petrol_caption.transition().duration(300).text("");
		  curYear.transition().duration(300).text("");
	   	}; 


	   	mousemove = function(){
	   		year = line_x.invert(d3.mouse(this)[0]).getFullYear();
	   		month = line_x.invert(d3.mouse(this)[0]).getMonth();
	   		monthname = monthNames[month];
	   		monthFullName = monthFullNames[month];
	   		nearestMonthyear = month + " " + year; 
 			nearestDate = new Date(year, month, 1);
 			// console.log(monthname + " " + year);
 			// console.log(timearray);
 			timeindex = timearray.indexOf(nearestMonthyear);
 			if (timeindex>0) {
 			

 			

 			petrol_yval = petrol_values[timeindex];
 			death_yval = death_values[timeindex];
 			var deathLabel = "Driver Deaths: " + death_yval
 			var deathDelta = death_yval-Math.round(monthAvgs[month]);

 			if (deathDelta > 0){
 				deathAvgLabel =  Math.abs(deathDelta) + " above " + monthFullName + " average"
 			} else {
 				deathAvgLabel = Math.abs(deathDelta) + " below " + monthFullName + " average"
 			};

 			death_circle.attr("cx", line_x(nearestDate))
 			.attr("cy", death_y(death_yval));

 			death_caption.attr("x", line_x(nearestDate))
 			.attr("y", death_y(deathExtent[1]))
 			// .attr("y", death_y(death_yval)-4)
 			.text(deathLabel);

 			death_caption2.attr("x", line_x(nearestDate))
 			.attr("y", death_y(deathExtent[1]))
 			// .attr("y", death_y(death_yval)-4)
 			.text(deathAvgLabel);


 			petrol_circle.attr("cx", line_x(nearestDate))
 			.attr("cy", pet_y(petrol_yval)); 

 			petrol_caption.attr("x", line_x(nearestDate))
 			.attr("y", pet_y(petExtent[1]))
 			// .attr("y", pet_y(petrol_yval)-4)
 			.text("Petrol Price " + Math.round(100*petrol_yval)/100);

 			curYear.attr("x", line_x(nearestDate))
 			.text(monthname + " " + year );
 			} else {
 				mouseout.call(this);
 			}
	   	}

	    petrol_svg.append("rect")
	      .attr("class", "background")
	      .style("pointer-events", "all")
	      .attr("width", width + margin.right )
	      .attr("height", height)
	      .on("mouseover", mouseover)
		  .on("mousemove", mousemove)
		  .on("mouseout", mouseout)
		;


      	death_svg.append("rect")
	      .attr("class", "background")
	      .style("pointer-events", "all")
	      .attr("width", width + margin.right )
	      .attr("height", height)
	      .on("mouseover", mouseover)
		  .on("mousemove", mousemove)
		  .on("mouseout", mouseout)
		;


	    petrol_svg.append("g")
	      .attr("class", "y axis")
	      .call(pet_yAxis);

	    death_svg.append("g")
	      .attr("class", "y axis")
	      .call(death_yAxis);

	      syear1 = death_svg.append("text")
		  .attr("class", "static_year")
		  .attr("text-anchor", "start")
		  .style("pointer-events", "none")
		  .attr("dy", 13)
		  .attr("y", height)
		  .attr("x", 0)
		  .style("font-size", 18)
		  .text(timedomain[0].getFullYear());


	     syear2 = death_svg.append("text")
		  .attr("class", "static_year")
		  .attr("text-anchor", "end")
		  .style("pointer-events", "none")
		  .attr("dy", 13)
		  .attr("y", height)
		  .attr("x", width)
		  .style("font-size", 18)
		  .text(timedomain[1].getFullYear());


	    var petpoints = petrol_svg
	    .append("path")
	    .datum(data)
	    .attr("class", "line petrolline")
	    .attr("d", pet_line);

	    var deathpoints = death_svg
	      .append("path")
	      .datum(data)
	    .attr("class", "line deathline")
	    .attr("d", death_line);

	    var curYear = death_svg.append("text")
		  .attr("class", "year")
		  .attr("text-anchor", "middle")
		  .style("pointer-events", "none")
		  .style("font-size", 18)
		  .attr("dy", 13)
		  .attr("y", height);

		var death_caption = death_svg.append("text")
		  .attr("class", "caption")
		  .attr("text-anchor", "middle")
		  .style("pointer-events", "none")
		  .style("font-size", 16)
		  .style("fill","#de2d26")
		  .attr("dy", -8);

		var death_caption2 = death_svg.append("text")
		  .attr("class", "caption")
		  .attr("text-anchor", "middle")
		  .style("pointer-events", "none")
		  .style("font-size", 10)
		  .style("fill","#de2d26")
		  .attr("dy", 4);
		  // .attr("dy", -8);


  		var petrol_caption = petrol_svg.append("text")
		  .attr("class", "caption")
		  .attr("text-anchor", "middle")
		  .style("pointer-events", "none")
		  .style("font-size", 16)
		  .style("fill", "#756bb1")
		  .attr("dy", -8);

		var death_circle = death_svg.append("circle")
		  .attr("r", 3)
		  .attr("opacity", 0)
		  .style("fill", "#de2d26")
		  .style("pointer-events", "none");

		var petrol_circle = petrol_svg.append("circle")
		  .attr("r", 3)
		  .attr("opacity", 0)
		  .style("fill", "#756bb1")
		  .style("pointer-events", "none");



		var petrolLabel = petrol_svg.append("text")
		  .attr("class", "label")
		  .attr("text-anchor", "start")
		  .style("pointer-events", "none")
		  .style("font-size", 12)
		  .style("fill", "#756bb1")
		  .attr("x", line_x(fullDatesArray[fullDatesArray.length-1]) + 6)
		  .attr("y", pet_y(petrol_values[petrol_values.length-1]))
		  .text("Petrol Price");

		  var deathLabel = death_svg.append("text")
		  .attr("class", "label")
		  .attr("text-anchor", "start")
		  .style("pointer-events", "none")
		  .style("font-size", 12)
		  .style("fill", "#de2d26")
		  .attr("x", line_x(fullDatesArray[fullDatesArray.length-1]) + 3)
		  .attr("y", death_y(death_values[death_values.length-1]) - 3)
		  .text("Driver Deaths");

		  ///area chart 
		var color_scale = d3.scale.ordinal()
		  		.domain(["DriversKilled", "driversInjured"])
		  		.range(["#fc9272","#bcbddc"]);

		

		var stack = d3.layout.stack()
		    .values(function(d) { return d.values; });

		var casualtyTypes = stack(color_scale.domain().map(function(name) {
		    return {
		      name: name,
		      values: data.map(function(d) {
		        return {date: d.month, y: d[name]};
		      })
		    };
		  }));

	  area_x.domain(timedomain);
	  area_y.domain([0, d3.max(data.map(function(d) { return d.driversInjured; }))]);
	  area_x2.domain(area_x.domain());
	  area_y2.domain(area_y.domain());

	  	var casualty = focus.selectAll(".casualty")
		      .data(casualtyTypes)
		    .enter().append("g")
		      .attr("class", "casualty");

		var stacked_area = d3.svg.area()
		    .x(function(d) { return area_x(d.date); })
		    .y0(function(d) { return area_y(d.y0); })
		    .y1(function(d) { return area_y(d.y0 + d.y); });

		function brushed() {
			  area_x.domain(brush.empty() ? area_x2.domain() : brush.extent());
			  focus.selectAll(".casualty").select(".area").attr("d", function(d) { return stacked_area(d.values); });
			  focus.select(".x.axis").call(area_xAxis);
			};

		var brush = d3.svg.brush()
	    .x(area_x2)
	    .on("brush", brushed);

		casualty.append("path")
	      .attr("class", "area")
	      .attr("d", function(d) { return stacked_area(d.values); })
	      .style("fill", function(d) { return color_scale(d.name); });

		  // focus.append("path")
		  //     .datum(data)
		  //     .attr("class", "area")
		  //     .attr("d", area);

		  focus.append("g")
		      .attr("class", "x axis")
		      .attr("transform", "translate(0," + area_height + ")")
		      .call(area_xAxis);

		  focus.append("g")
		      .attr("class", "y axis")
		      .call(area_yAxis);

		  context.append("path")
		      .datum(data)
		      .attr("class", "area")
		      .attr("d", area2);

		  context.append("g")
		      .attr("class", "x axis")
		      .attr("transform", "translate(0," + area_height2 + ")")
		      .call(area_xAxis2);

		  context.append("g")
		      .attr("class", "x brush")
		      .call(brush)
		    .selectAll("rect")
		      .attr("y", -6)
		      .attr("height", area_height2 + 7);


//deathred #de2d26
//deathorange #fc9272
//petrollight #bcbddc
//petroldark #756bb1
	});


	</script>
</body>
</html>